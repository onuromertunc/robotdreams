---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-stable
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
      version: stable
  template:
    metadata:
      labels:
        app: nginx
        version: stable
    spec:
      containers:
      - name: nginx
        image: nginx:1.18
        ports:
        - containerPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
      version: canary
  template:
    metadata:
      labels:
        app: nginx
        version: canary
    spec:
      containers:
      - name: nginx
        image: nginx:1.19
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: NodePort

#Tum stable tag olan podlarin html sayfalarini degistir.
for pod in $(kubectl get pod -l app=nginx,version=stable -o jsonpath="{.items[*].metadata.name}"); do
  kubectl exec -it $pod -- sh -c "echo '<h1>Stable Version</h1>' > /usr/share/nginx/html/index.html"
done

#Canary tag olan podlarin html sayfalarini degistir.
kubectl exec -it $(kubectl get pod -l app=nginx,version=canary -o jsonpath="{.items[0].metadata.name}") -- sh -c "echo '<h1>Canary Version</h1>' > /usr/share/nginx/html/index.html"

#Test et
kubectl run curlpod --image=radial/busyboxplus:curl -i --tty
while true; do curl -s http://nginx-service:80; echo ""; sleep 1; done


